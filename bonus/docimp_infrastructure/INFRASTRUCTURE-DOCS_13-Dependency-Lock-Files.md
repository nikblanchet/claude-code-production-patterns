# Infrastructure Documentation: Dependency Lock Files

## Overview

DocImp uses lock files to ensure reproducible builds across development environments, CI/CD pipelines, and production deployments. The project employs two distinct package management ecosystems:

- **Python**: uv package manager with multiple lock file formats
- **TypeScript/JavaScript**: npm with package-lock.json

This document provides comprehensive coverage of lock file management, synchronization procedures, conflict resolution strategies, and troubleshooting guidance for maintaining consistent dependency versions across the polyglot codebase.

**Why Lock Files Matter:**
- **Reproducibility**: Identical dependency versions across all environments
- **Security**: Pin known-good versions, prevent supply chain attacks
- **Debugging**: Correlation between code changes and dependency updates
- **CI/CD Reliability**: Eliminate "works on my machine" dependency drift

---

## Python Dependency Management with uv

### Lock File Architecture

DocImp uses **uv** (Astral's ultra-fast Python package manager) as the exclusive Python dependency manager. The project maintains multiple lock file formats to support different use cases:

#### File Locations

```
/Users/nik/Documents/Code/Polygot/docimp/
├── pyproject.toml              # Project metadata, dependencies
├── uv.lock                     # uv's native lockfile (cross-platform)
├── requirements.lock           # Locked runtime dependencies
├── requirements-dev.lock       # Locked dev dependencies
└── requirements.txt            # Base requirements specification
```

#### Lock File Roles

| File                     | Purpose                                      | When to Use                          |
|--------------------------|----------------------------------------------|--------------------------------------|
| `uv.lock`                | uv's native lockfile (all deps)              | Primary source of truth for uv       |
| `requirements.lock`      | Runtime dependencies only                    | Production deployments               |
| `requirements-dev.lock`  | Dev dependencies (test, lint, type checking) | Development environments, CI/CD      |
| `requirements.txt`       | Human-readable base requirements             | Initial project setup, documentation |

### uv.lock Structure

uv's native lockfile uses a custom format optimized for speed and cross-platform compatibility:

```toml
# Example excerpt from uv.lock
[[package]]
name = "anthropic"
version = "0.72.0"
source = { registry = "https://pypi.org/simple" }
dependencies = [
    { name = "httpx", version = "0.27.0" },
    { name = "pydantic", version = "2.12.3" },
    { name = "typing-extensions", version = "4.9.0" },
]

[[package]]
name = "pydantic"
version = "2.12.3"
source = { registry = "https://pypi.org/simple" }
dependencies = [
    { name = "pydantic-core", version = "2.41.4" },
    { name = "typing-extensions", version = "4.9.0" },
]
```

**Key Features:**
- **Transitive Dependencies**: Fully resolved dependency tree with exact versions
- **Platform Markers**: Supports platform-specific dependencies (Linux, macOS, Windows)
- **Hash Verification**: Includes SHA-256 hashes for package integrity
- **Source Tracking**: Records PyPI URLs for each package

### requirements.lock Format

Traditional pip-compatible format for runtime dependencies:

```
# This file is autogenerated by uv pip compile
# To update, run: uv pip compile pyproject.toml -o requirements.lock

anthropic==0.72.0
    # via docimp-analyzer (pyproject.toml)
httpx==0.27.0
    # via anthropic
pydantic==2.12.3
    # via docimp-analyzer (pyproject.toml)
pydantic-core==2.41.4
    # via pydantic
typing-extensions==4.9.0
    # via
    #   anthropic
    #   pydantic
```

**Benefits:**
- **Pip Compatibility**: Works with legacy pip workflows
- **Traceability**: Comments show why each package is included
- **Exact Versions**: `==` pins prevent unexpected upgrades

### requirements-dev.lock Format

Development dependencies (testing, linting, type checking):

```
# This file is autogenerated by uv pip compile
# To update, run: uv pip compile pyproject.toml --extra dev -o requirements-dev.lock

# Runtime dependencies (repeated from requirements.lock)
anthropic==0.72.0
pydantic==2.12.3
# ... (truncated for brevity)

# Development-only dependencies
pytest==7.4.3
    # via
    #   docimp-analyzer (pyproject.toml)
    #   pytest-cov
pytest-cov==4.1.0
    # via docimp-analyzer (pyproject.toml)
ruff==0.1.9
    # via docimp-analyzer (pyproject.toml)
mypy==1.7.1
    # via docimp-analyzer (pyproject.toml)
coverage==7.3.2
    # via pytest-cov
```

**Usage Patterns:**
- **Local Development**: `uv pip sync requirements-dev.lock`
- **CI/CD**: `uv pip sync requirements-dev.lock` (runs all quality checks)
- **Production**: `uv pip sync requirements.lock` (minimal surface area)

---

## Python Dependency Workflows

### Initial Environment Setup

**For New Contributors:**

```bash
# 1. Clone repository
git clone <repo-url>
cd docimp

# 2. Create virtual environment with uv
uv venv .venv

# 3. Activate environment (automatically via direnv)
# direnv allow  # (if using direnv)

# 4. Install locked dependencies
uv pip sync requirements-dev.lock

# 5. Install project in editable mode
uv pip install -e .
```

**Why This Works:**
- `uv venv` creates isolated Python 3.13 environment
- `uv pip sync` installs exact versions from lockfile (reproducible)
- `-e .` installs project in development mode (code changes apply immediately)

### Adding New Dependencies

**Procedure:**

```bash
# 1. Add dependency to pyproject.toml
# Edit [project.dependencies] or [project.optional-dependencies.dev]

# 2. Update lock files
uv pip compile pyproject.toml -o requirements.lock
uv pip compile pyproject.toml --extra dev -o requirements-dev.lock

# 3. Sync your environment
uv pip sync requirements-dev.lock

# 4. Verify installation
uv run python -c "import <new_package>"

# 5. Commit all changes
git add pyproject.toml requirements.lock requirements-dev.lock uv.lock
git commit -m "Add <package> dependency"
```

**Example: Adding `requests` Library**

```bash
# 1. Edit pyproject.toml
cat >> pyproject.toml << 'EOF'
dependencies = [
  "anthropic>=0.72.0,<1.0.0",
  "pydantic>=2.12.3,<3.0.0",
  "requests>=2.31.0,<3.0.0",  # NEW
]
EOF

# 2. Recompile locks
uv pip compile pyproject.toml -o requirements.lock
uv pip compile pyproject.toml --extra dev -o requirements-dev.lock

# 3. Sync environment
uv pip sync requirements-dev.lock

# 4. Verify
uv run python -c "import requests; print(requests.__version__)"
# Output: 2.31.0 (or compatible version)

# 5. Commit
git add pyproject.toml requirements*.lock uv.lock
git commit -m "Add requests library for HTTP client functionality"
```

### Updating Dependencies

**Update All Dependencies to Latest Compatible Versions:**

```bash
# 1. Remove old lock files
rm requirements.lock requirements-dev.lock uv.lock

# 2. Regenerate with latest versions
uv pip compile pyproject.toml -o requirements.lock
uv pip compile pyproject.toml --extra dev -o requirements-dev.lock

# 3. Sync environment
uv pip sync requirements-dev.lock

# 4. Run full test suite
uv run pytest -v

# 5. Run quality checks
uv run ruff check .
uv run mypy src --ignore-missing-imports

# 6. If all pass, commit
git add requirements*.lock uv.lock
git commit -m "Update Python dependencies to latest compatible versions"
```

**Update Single Package:**

```bash
# 1. Edit pyproject.toml version constraint
# Change: "anthropic>=0.72.0,<1.0.0"
# To:     "anthropic>=0.75.0,<1.0.0"

# 2. Recompile locks
uv pip compile pyproject.toml -o requirements.lock
uv pip compile pyproject.toml --extra dev -o requirements-dev.lock

# 3. Sync and test
uv pip sync requirements-dev.lock
uv run pytest -v

# 4. Commit if tests pass
git add pyproject.toml requirements*.lock uv.lock
git commit -m "Update anthropic SDK to >=0.75.0"
```

### Removing Dependencies

**Procedure:**

```bash
# 1. Remove from pyproject.toml
# Delete line from [project.dependencies]

# 2. Recompile locks (orphaned transitive deps auto-removed)
uv pip compile pyproject.toml -o requirements.lock
uv pip compile pyproject.toml --extra dev -o requirements-dev.lock

# 3. Sync environment (uninstalls removed packages)
uv pip sync requirements-dev.lock

# 4. Verify removal
uv run python -c "import <removed_package>"
# Should raise ImportError

# 5. Commit
git add pyproject.toml requirements*.lock uv.lock
git commit -m "Remove <package> dependency (no longer needed)"
```

---

## Per-Worktree Environment Isolation

### Architecture

DocImp uses **git worktrees** for parallel feature development. Each worktree maintains an **isolated Python virtual environment** to prevent lock contention and dependency conflicts.

**Directory Structure:**

```
/Users/nik/Documents/Code/Polygot/
├── docimp/                     # Main worktree
│   ├── .venv/                  # Main environment
│   ├── pyproject.toml
│   └── requirements*.lock
├── .docimp-wt/                 # Worktree directory
│   ├── issue-243/              # Feature worktree
│   │   ├── .venv/              # Isolated environment
│   │   ├── .envrc              # Symlink to main
│   │   ├── pyproject.toml      # Symlink to main
│   │   └── requirements*.lock  # Symlink to main
│   └── issue-221/              # Another feature worktree
│       ├── .venv/              # Separate isolated environment
│       └── ...
```

**Key Design Decisions:**
- **Isolated .venv/**: Each worktree has its own virtual environment
- **Shared Lock Files**: Symlinks ensure all worktrees use same dependency versions
- **Auto-Setup**: create_worktree.py script handles environment creation

### Worktree Environment Creation

The `create_worktree.py` script (from git-workflow skill) automates environment setup:

```python
# Excerpt from create_worktree.py
def setup_python_environment(worktree_path: Path) -> None:
    """Create isolated Python environment for worktree."""
    venv_path = worktree_path / ".venv"

    # Create virtual environment
    subprocess.run(["uv", "venv", str(venv_path)], check=True)

    # Sync dependencies from main repo's lock files
    subprocess.run(
        ["uv", "pip", "sync", "requirements-dev.lock"],
        cwd=worktree_path,
        check=True
    )

    # Install project in editable mode
    subprocess.run(
        ["uv", "pip", "install", "-e", "."],
        cwd=worktree_path,
        check=True
    )
```

**What This Achieves:**
1. Creates fresh `.venv/` in worktree
2. Installs exact versions from shared `requirements-dev.lock`
3. Installs project in editable mode (code changes apply immediately)
4. Worktrees can diverge in code but share dependency versions

### Syncing Worktree Environments

**Scenario**: Main branch updates dependencies, need to sync feature worktrees.

```bash
# From feature worktree (e.g., .docimp-wt/issue-243/)
cd /Users/nik/Documents/Code/Polygot/.docimp-wt/issue-243/

# 1. Check if lock files changed (symlink targets updated)
git status
# Output: pyproject.toml, requirements*.lock modified (via symlink)

# 2. Re-sync environment
uv pip sync requirements-dev.lock

# 3. Verify updated versions
uv pip list | grep anthropic
# Output: anthropic 0.75.0 (updated from 0.72.0)

# 4. Run tests to ensure compatibility
uv run pytest -v
```

**Alternative: Nuclear Option (Clean Reinstall)**

```bash
# If environment gets corrupted or has orphaned packages
cd /Users/nik/Documents/Code/Polygot/.docimp-wt/issue-243/

# 1. Remove old environment
rm -rf .venv/

# 2. Recreate from scratch
uv venv .venv
uv pip sync requirements-dev.lock
uv pip install -e .

# 3. Verify
uv run python -c "import src; print('Success')"
```

---

## Node.js Dependency Management with npm

### Lock File Architecture

DocImp's TypeScript CLI uses **npm** with `package-lock.json` for deterministic dependency resolution.

#### File Locations

```
/Users/nik/Documents/Code/Polygot/docimp/cli/
├── package.json          # Project metadata, dependencies, scripts
├── package-lock.json     # Locked dependency tree (commit this)
└── node_modules/         # Installed packages (gitignored)
```

### package-lock.json Structure

npm's lockfile uses JSON format with nested dependency trees:

```json
{
  "name": "docimp-cli",
  "version": "1.0.6-α",
  "lockfileVersion": 3,
  "requires": true,
  "packages": {
    "": {
      "name": "docimp-cli",
      "version": "1.0.6-α",
      "dependencies": {
        "chalk": "^5.3.0",
        "commander": "^11.1.0",
        "ora": "^8.0.1",
        "prompts": "^2.4.2",
        "uuid": "^9.0.1",
        "zod": "^3.22.4"
      },
      "devDependencies": {
        "@typescript-eslint/eslint-plugin": "^6.13.2",
        "jest": "^29.7.0",
        "prettier": "^3.1.0",
        "typescript": "^5.3.3"
      }
    },
    "node_modules/chalk": {
      "version": "5.3.0",
      "resolved": "https://registry.npmjs.org/chalk/-/chalk-5.3.0.tgz",
      "integrity": "sha512-dLitG79d+GV1Nb/VYcCDFivJeK1hiukt9QjRNVOsUtTy1rR1YJsmpGGTZ3qJos+uw7WmWF4wUwBd9jxjocFC2w==",
      "engines": {
        "node": "^12.17.0 || ^14.13 || >=16.0.0"
      }
    }
  }
}
```

**Key Features:**
- **Nested Structure**: Flattened when possible, nested for version conflicts
- **Integrity Hashes**: SHA-512 subresource integrity checksums
- **Registry URLs**: Tracks download source for each package
- **Version Resolution**: Records exact version selected from semver range

### package.json Dependencies

DocImp CLI dependencies organized by category:

```json
{
  "dependencies": {
    "commander": "^11.1.0",      // CLI framework
    "chalk": "^5.3.0",           // Terminal colors (ESM only)
    "ora": "^8.0.1",             // Spinners
    "prompts": "^2.4.2",         // Interactive prompts
    "uuid": "^9.0.1",            // UUID generation
    "zod": "^3.22.4",            // Runtime validation
    "typescript": "^5.3.3"       // Language (also in devDeps)
  },
  "devDependencies": {
    "@typescript-eslint/eslint-plugin": "^6.13.2",
    "@typescript-eslint/parser": "^6.13.2",
    "eslint": "^9.0.0",
    "eslint-config-prettier": "^9.1.0",
    "eslint-plugin-jsdoc": "^46.9.0",
    "jest": "^29.7.0",
    "ts-jest": "^29.1.1",
    "prettier": "^3.1.0",
    "husky": "^9.1.7",
    "lint-staged": "^15.2.0"
  }
}
```

**Version Constraints:**
- `^` (caret): Compatible updates (e.g., `^5.3.0` allows `5.3.1`, `5.4.0`, but not `6.0.0`)
- `~` (tilde): Patch-level updates only (not used in DocImp)
- Exact versions: Used for critical deps requiring pin (none currently)

---

## Node.js Dependency Workflows

### Initial Setup

**For New Contributors:**

```bash
# From repository root
cd /Users/nik/Documents/Code/Polygot/docimp/cli

# 1. Install exact versions from lockfile
npm ci

# 2. Verify installation
npm list --depth=0

# 3. Run tests to confirm setup
npm test
```

**Why `npm ci` Instead of `npm install`:**
- **Faster**: Skips dependency resolution (uses lockfile directly)
- **Reproducible**: Errors if `package.json` and `package-lock.json` out of sync
- **Clean State**: Deletes `node_modules/` before install (no orphaned packages)

### Adding Dependencies

**Production Dependency:**

```bash
cd cli/

# Add package and update lock file
npm install axios

# Verify addition
git status
# Shows: package.json, package-lock.json modified

# Commit both files
git add package.json package-lock.json
git commit -m "Add axios HTTP client dependency"
```

**Development Dependency:**

```bash
cd cli/

# Add dev dependency
npm install --save-dev @types/node

# Verify
npm list --depth=0 --dev

# Commit
git add package.json package-lock.json
git commit -m "Add Node.js type definitions"
```

### Updating Dependencies

**Update All Dependencies:**

```bash
cd cli/

# 1. Update all to latest compatible versions
npm update

# 2. Review changes
git diff package-lock.json

# 3. Run full test suite
npm run test:all

# 4. Run lint and type check
npm run lint
npm run build

# 5. If all pass, commit
git add package-lock.json
git commit -m "Update npm dependencies to latest compatible versions"
```

**Update Specific Package:**

```bash
cd cli/

# Update single package to latest compatible version
npm update commander

# Or update to specific version
npm install commander@12.0.0

# Test and commit
npm test
git add package.json package-lock.json
git commit -m "Update commander to v12.0.0"
```

**Check for Outdated Packages:**

```bash
cd cli/

npm outdated
# Output:
# Package      Current  Wanted  Latest  Location
# chalk          5.3.0   5.3.0   5.4.1  docimp-cli
# typescript     5.3.3   5.3.9   5.8.1  docimp-cli
```

**Columns Explained:**
- **Current**: Installed version
- **Wanted**: Latest version satisfying semver range in `package.json`
- **Latest**: Absolute latest version (may break compatibility)

### Removing Dependencies

```bash
cd cli/

# Remove package
npm uninstall axios

# Verify removal
npm list axios
# Output: (empty)

# Commit
git add package.json package-lock.json
git commit -m "Remove axios dependency (no longer needed)"
```

---

## Per-Worktree Node.js Environments

### Shared vs. Isolated Node Modules

**DocImp Approach**: Shared `node_modules/` via symlinks for consistency.

**Directory Structure:**

```
/Users/nik/Documents/Code/Polygot/
├── docimp/                     # Main worktree
│   └── cli/
│       ├── node_modules/       # Physical directory
│       └── package-lock.json
├── .docimp-wt/
│   ├── issue-243/              # Feature worktree
│   │   └── cli/
│   │       ├── node_modules/   # Symlink → main
│   │       ├── package.json    # Symlink → main
│   │       └── package-lock.json  # Symlink → main
│   └── issue-221/
│       └── cli/
│           └── node_modules/   # Symlink → main
```

**Rationale:**
- **Disk Space**: node_modules can be 200+ MB; sharing saves space
- **Consistency**: All worktrees use identical package versions
- **Speed**: No need to reinstall in each worktree

**Setup (Automated by create_worktree.py):**

```bash
# Excerpt from create_worktree.py
def setup_node_environment(worktree_path: Path, main_repo_path: Path) -> None:
    """Link Node.js dependencies to main repo."""
    worktree_cli = worktree_path / "cli"
    main_cli = main_repo_path / "cli"

    # Create symlinks to shared files
    symlinks = {
        "package.json": main_cli / "package.json",
        "package-lock.json": main_cli / "package-lock.json",
        "node_modules": main_cli / "node_modules",
    }

    for link_name, target in symlinks.items():
        link_path = worktree_cli / link_name
        link_path.symlink_to(target)

    # Run npm install in main repo (if needed)
    if not (main_cli / "node_modules").exists():
        subprocess.run(["npm", "ci"], cwd=main_cli, check=True)
```

### Handling Divergent Dependencies in Worktrees

**Scenario**: Feature branch needs experimental package not in main.

**Solution: Temporary Local Installation**

```bash
# From feature worktree
cd /Users/nik/Documents/Code/Polygot/.docimp-wt/issue-243/cli

# 1. Break symlink to package.json
rm package.json
cp ../../../docimp/cli/package.json .

# 2. Install local dependency
npm install --save-dev experimental-package

# 3. Install to local node_modules
rm node_modules  # (breaks symlink)
npm ci

# 4. Work with experimental package
# ... (development)

# 5. Before merging: remove experimental package
npm uninstall experimental-package
rm -rf node_modules package.json package-lock.json

# 6. Restore symlinks
ln -s ../../../docimp/cli/package.json package.json
ln -s ../../../docimp/cli/package-lock.json package-lock.json
ln -s ../../../docimp/cli/node_modules node_modules
```

**Alternative: Use main Branch for Permanent Dependencies**

```bash
# Switch to main worktree
cd /Users/nik/Documents/Code/Polygot/docimp/cli

# Add dependency to main
npm install new-package

# Commit to main branch
git add package.json package-lock.json
git commit -m "Add new-package for feature X"
git push origin main

# Return to feature worktree (auto-updated via symlinks)
cd /Users/nik/Documents/Code/Polygot/.docimp-wt/issue-243/cli
npm list new-package
# Output: new-package@1.0.0
```

---

## Lock File Conflict Resolution

### Git Merge Conflicts in Lock Files

**Common Scenario**: Two branches update different dependencies, causing merge conflicts in lock files.

**Example Conflict:**

```
<<<<<<< HEAD (feature-branch)
  "dependencies": {
    "chalk": "^5.3.0",
    "commander": "^12.0.0",
=======
  "dependencies": {
    "chalk": "^5.4.0",
    "commander": "^11.1.0",
>>>>>>> main
```

### Python Lock File Conflicts (uv)

**Resolution Strategy: Regenerate Lock Files**

```bash
# 1. Accept incoming changes from main
git checkout --theirs requirements.lock
git checkout --theirs requirements-dev.lock
git checkout --theirs uv.lock

# 2. Regenerate locks with both branches' dependencies
uv pip compile pyproject.toml -o requirements.lock
uv pip compile pyproject.toml --extra dev -o requirements-dev.lock

# 3. Sync environment
uv pip sync requirements-dev.lock

# 4. Run tests to verify compatibility
uv run pytest -v

# 5. Mark conflicts resolved
git add requirements*.lock uv.lock
git commit -m "Merge lock files: regenerate with updated dependencies"
```

**Why This Works:**
- uv resolver handles dependency constraints from both branches
- Regeneration picks latest compatible versions
- Tests confirm no breaking changes

### npm Lock File Conflicts

**Resolution Strategy: Use npm to Resolve**

```bash
cd cli/

# 1. Accept one side's package.json (usually feature branch)
git checkout --ours package.json

# 2. Delete conflicted lock file
rm package-lock.json

# 3. Regenerate lock file
npm install

# 4. Verify
npm list --depth=0

# 5. Run tests
npm test

# 6. Commit resolved files
git add package.json package-lock.json
git commit -m "Merge package-lock.json: resolve dependency conflicts"
```

**Alternative: Accept Theirs and Add Your Changes**

```bash
cd cli/

# 1. Accept main branch lock file
git checkout --theirs package-lock.json
git checkout --theirs package.json

# 2. Re-add your branch's dependencies
npm install your-new-package

# 3. Test and commit
npm test
git add package.json package-lock.json
git commit -m "Merge lock files: preserve both sets of dependencies"
```

### Automated Conflict Resolution (CI/CD)

**GitHub Actions Workflow:**

```yaml
# .github/workflows/lock-file-check.yml
name: Lock File Validation

on:
  pull_request:
    paths:
      - '**/package.json'
      - '**/package-lock.json'
      - '**/pyproject.toml'
      - '**/*.lock'

jobs:
  validate-locks:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # Python lock file validation
      - name: Validate Python locks
        run: |
          uv pip compile pyproject.toml -o /tmp/requirements.lock
          diff requirements.lock /tmp/requirements.lock

      # npm lock file validation
      - name: Validate npm lock
        run: |
          cd cli
          npm ci
          git diff --exit-code package-lock.json
```

**What This Catches:**
- Lock files out of sync with package.json/pyproject.toml
- Uncommitted lock file changes
- Merge conflicts that weren't properly resolved

---

## Troubleshooting

### Python (uv) Issues

#### Problem: "Package not found" Error

```
Error: Package 'anthropic' not found in requirements-dev.lock
```

**Solution:**

```bash
# Verify package in pyproject.toml
grep anthropic pyproject.toml

# Regenerate lock files
uv pip compile pyproject.toml -o requirements.lock
uv pip compile pyproject.toml --extra dev -o requirements-dev.lock

# Sync environment
uv pip sync requirements-dev.lock
```

#### Problem: "Conflicting dependencies" Error

```
Error: Cannot resolve dependencies: anthropic requires pydantic>=2.12.3,
but other package requires pydantic<2.0.0
```

**Solution:**

```bash
# Identify conflicting package
uv pip compile pyproject.toml --verbose

# Update pyproject.toml to resolve conflict
# Either: Update conflicting package to compatible version
# Or: Remove incompatible dependency

# Regenerate locks
uv pip compile pyproject.toml -o requirements.lock
uv pip compile pyproject.toml --extra dev -o requirements-dev.lock
```

#### Problem: "Environment out of sync"

```
ImportError: No module named 'anthropic'
```

**Solution:**

```bash
# Nuclear option: recreate environment
rm -rf .venv/
uv venv .venv
uv pip sync requirements-dev.lock
uv pip install -e .

# Verify
uv run python -c "import anthropic; print(anthropic.__version__)"
```

### Node.js (npm) Issues

#### Problem: "Integrity checksum failed"

```
npm ERR! Integrity checksum failed when using sha512: wanted sha512-... but got sha512-...
```

**Solution:**

```bash
cd cli/

# Clear npm cache
npm cache clean --force

# Reinstall
rm -rf node_modules/
npm ci
```

#### Problem: "Peer dependency conflict"

```
npm WARN ERESOLVE overriding peer dependency
npm ERR! Could not resolve dependency: peer @typescript-eslint/parser@"^6.0.0"
```

**Solution:**

```bash
# Option 1: Update conflicting package
npm install @typescript-eslint/parser@latest

# Option 2: Use --force to override (risky)
npm install --force

# Option 3: Use --legacy-peer-deps (maintains npm v6 behavior)
npm install --legacy-peer-deps
```

#### Problem: "Lock file out of sync"

```
npm ERR! npm ci can only install packages when your package.json and package-lock.json
npm ERR! are in sync. Please update your lock file with `npm install` before continuing.
```

**Solution:**

```bash
cd cli/

# Regenerate lock file
npm install

# Commit updated lock file
git add package-lock.json
git commit -m "Sync package-lock.json with package.json"
```

### Cross-Platform Lock File Issues

#### Problem: Platform-Specific Dependencies

**Python Example: fsspec with different deps on Windows vs. Linux**

```toml
# uv.lock automatically handles platform markers
[[package]]
name = "fsspec"
version = "2024.3.1"
dependencies = [
    { name = "aiohttp", version = "3.9.3", marker = "python_version < '3.12'" },
]
```

**No Action Needed**: uv automatically selects platform-appropriate versions.

#### Problem: Line Ending Conflicts (CRLF vs. LF)

**Solution: .gitattributes**

```gitattributes
# Ensure lock files always use LF (Unix line endings)
*.lock text eol=lf
package-lock.json text eol=lf
uv.lock text eol=lf
```

---

## Best Practices

### Lock File Hygiene

1. **Always Commit Lock Files**: Never add to `.gitignore`
2. **Update Atomically**: Lock files + package.json in same commit
3. **Review Changes**: Inspect lock file diffs before committing (look for unexpected upgrades)
4. **Run Tests After Updates**: Ensure no breaking changes introduced
5. **Keep Comments**: requirements*.lock comments show dependency provenance

### Dependency Update Cadence

| Frequency   | Action                          | Rationale                              |
|-------------|---------------------------------|----------------------------------------|
| Weekly      | Run `npm outdated`              | Identify available updates             |
| Bi-weekly   | Update patch versions           | Security fixes, low-risk updates       |
| Monthly     | Update minor versions           | New features, moderate risk            |
| Quarterly   | Update major versions           | Breaking changes, high-risk, plan time |
| Immediately | Security vulnerabilities        | CVEs require emergency updates         |

### Security Scanning

**Python:**

```bash
# Check for known vulnerabilities (if using pip-audit)
uv run pip-audit

# Alternative: Use GitHub Dependabot (auto-enabled for public repos)
```

**Node.js:**

```bash
cd cli/

# Check for vulnerabilities
npm audit

# Auto-fix non-breaking vulnerabilities
npm audit fix

# Fix including breaking changes (risky)
npm audit fix --force
```

### Reproducibility Checklist

Before merging PRs:

- [ ] Lock files committed alongside package.json/pyproject.toml changes
- [ ] CI/CD passes with updated lock files
- [ ] Local tests pass with `npm ci` (not `npm install`)
- [ ] Python environment synced with `uv pip sync` (not manual installs)
- [ ] No manual edits to lock files (always regenerate)

---

## Quick Reference

### Python (uv) Commands

| Task                        | Command                                                    |
|-----------------------------|------------------------------------------------------------|
| Create virtual environment  | `uv venv .venv`                                            |
| Sync to lock file           | `uv pip sync requirements-dev.lock`                        |
| Add dependency              | Edit `pyproject.toml`, then `uv pip compile ...`           |
| Update all dependencies     | `rm *.lock && uv pip compile pyproject.toml -o ...`        |
| Update single package       | Edit `pyproject.toml` version, then `uv pip compile ...`   |
| Remove dependency           | Delete from `pyproject.toml`, then `uv pip compile ...`    |
| List installed packages     | `uv pip list`                                              |
| Show dependency tree        | `uv pip show <package>`                                    |
| Check for conflicts         | `uv pip compile pyproject.toml --verbose`                  |

### Node.js (npm) Commands

| Task                    | Command                          |
|-------------------------|----------------------------------|
| Install from lock file  | `npm ci`                         |
| Add dependency          | `npm install <package>`          |
| Add dev dependency      | `npm install --save-dev <pkg>`   |
| Update all dependencies | `npm update`                     |
| Update single package   | `npm update <package>`           |
| Remove dependency       | `npm uninstall <package>`        |
| Check for outdated deps | `npm outdated`                   |
| Audit vulnerabilities   | `npm audit`                      |
| Fix audit issues        | `npm audit fix`                  |
| List installed packages | `npm list --depth=0`             |

### File Locations Quick Lookup

| File                     | Location                                                   | Purpose                       |
|--------------------------|------------------------------------------------------------|-------------------------------|
| `pyproject.toml`         | `/Users/nik/Documents/Code/Polygot/docimp/`                | Python project metadata       |
| `uv.lock`                | `/Users/nik/Documents/Code/Polygot/docimp/`                | uv native lock file           |
| `requirements.lock`      | `/Users/nik/Documents/Code/Polygot/docimp/`                | Python runtime deps           |
| `requirements-dev.lock`  | `/Users/nik/Documents/Code/Polygot/docimp/`                | Python dev deps               |
| `package.json`           | `/Users/nik/Documents/Code/Polygot/docimp/cli/`            | Node.js project metadata      |
| `package-lock.json`      | `/Users/nik/Documents/Code/Polygot/docimp/cli/`            | npm lock file                 |
| `node_modules/`          | `/Users/nik/Documents/Code/Polygot/docimp/cli/` (gitignored) | Installed Node.js packages |

---

## Summary

DocImp's dependency management infrastructure ensures reproducible builds through:

1. **Dual Lock File Systems**: uv for Python, npm for Node.js
2. **Per-Worktree Isolation**: Python (.venv) isolated, Node.js (node_modules) shared via symlinks
3. **Automated Workflows**: create_worktree.py handles environment setup
4. **Conflict Resolution**: Regenerate lock files during merges
5. **CI/CD Validation**: GitHub Actions verifies lock file integrity

**Key Takeaways:**
- Always use `uv pip sync` and `npm ci` (never manual installs)
- Commit lock files alongside package.json/pyproject.toml changes
- Regenerate lock files to resolve merge conflicts
- Test after dependency updates
- Review lock file diffs before committing

**Next Steps**: See `INFRASTRUCTURE-DOCS_14-Interaction-Map-Data-Flow.md` for component interaction diagrams and workflow sequences that leverage this dependency infrastructure.
