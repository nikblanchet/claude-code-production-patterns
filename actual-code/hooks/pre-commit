#!/bin/bash
# pre-commit hook: Block commits on main branch in main worktree
#
# This hook prevents accidental commits to the main branch when working
# in the main repository worktree. Feature worktrees are unaffected.
#
# To bypass this check temporarily (for maintenance):
#   git commit --no-verify

# Colors for output
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Get current branch
current_branch=$(git symbolic-ref --short HEAD 2>/dev/null)

# Only check if we're on main branch
if [ "$current_branch" != "main" ]; then
    exit 0
fi

# Get the absolute path of the current worktree
current_worktree=$(git rev-parse --show-toplevel)

# Load worktree configuration
WORKTREE_PATTERN=""
CREATE_WORKTREE_SCRIPT="actual-code/create_worktree.py"
if [ -f "$current_worktree/.worktree-config" ]; then
    source "$current_worktree/.worktree-config"
fi

# Fallback: If no config file, try to auto-detect
if [ -z "$WORKTREE_PATTERN" ]; then
    # Look for common worktree patterns in the path
    if [[ "$current_worktree" =~ -wt- ]]; then
        WORKTREE_PATTERN="-wt-"
    else
        echo ""
        echo -e "${RED}Error: WORKTREE_PATTERN not set and could not auto-detect${NC}"
        echo ""
        echo "Please create .worktree-config from .worktree-config.template:"
        echo "  cp .worktree-config.template .worktree-config"
        echo "  # Edit .worktree-config with your project-specific pattern"
        echo ""
        exit 1
    fi
fi

# Get list of all worktrees and check if current is the main worktree
# The main worktree is the one that doesn't have the WORKTREE_PATTERN in its path
if [[ ! "$current_worktree" =~ $WORKTREE_PATTERN ]]; then
    # We're in the main worktree - block the commit
    echo ""
    echo -e "${RED}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${RED}✗ COMMIT BLOCKED${NC}"
    echo -e "${RED}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo ""
    echo -e "${YELLOW}Cannot commit on main branch in the main worktree.${NC}"
    echo ""
    echo "The main worktree is reserved for reference and worktree management."
    echo "All development work should be done in feature worktrees."
    echo ""
    echo "To create a new feature worktree:"
    echo "  python3 $CREATE_WORKTREE_SCRIPT <worktree-name> <branch-name>"
    echo ""
    echo "Example:"
    echo "  python3 $CREATE_WORKTREE_SCRIPT feature-x feature-x-implementation"
    echo ""
    echo "If you need to bypass this check (for maintenance only):"
    echo "  git commit --no-verify"
    echo ""
    exit 1
fi

# We're in a feature worktree - allow the commit
exit 0
